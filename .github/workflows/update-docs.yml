name: Update Documentation

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      projects:
        description: 'Projects to update (space-separated, empty for all)'
        required: false
        default: ''
      mode:
        description: 'Run mode'
        required: false
        default: '--update'
        type: choice
        options:
          - '--update'
          - '--html-only'
          - '--reanalyze'
          - '--reclassify'

jobs:
  update-docs:
    # Use self-hosted runner on your workstation
    # Falls back to ubuntu-latest if self-hosted unavailable
    runs-on: [self-hosted, linux, x64]
    
    # Required permissions for pushing to pages branch
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          # Don't run git clean - experiments/repos and experiments/sites are large
          # and should persist across runs for incremental updates
          clean: false
      
      - name: Ensure Elan is installed
        run: |
          if ! command -v elan &> /dev/null; then
            curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y --default-toolchain none
          fi
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
      
      - name: Ensure Git LFS is installed
        run: |
          if ! command -v git-lfs &> /dev/null; then
            echo "::error::Git LFS not found. Please install it on the self-hosted runner: sudo dnf install git-lfs"
            exit 1
          fi
          git lfs install
      
      - name: Build doc-verification-bridge
        run: lake build experiments
      
      - name: Run update pipeline
        run: |
          cd experiments
          PROJECTS="${{ github.event.inputs.projects }}"
          MODE="${{ github.event.inputs.mode || '--update' }}"
          if [ -n "$PROJECTS" ]; then
            ./run.sh run $MODE --projects $PROJECTS
          else
            ./run.sh run $MODE
          fi
        timeout-minutes: 1440  # 24 hours max for self-hosted
      
      - name: Deploy to GitHub Pages
        env:
          # Disable GPG signing for deployment commits (self-hosted runner may have signing configured)
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          # Disable commit signing for this deployment
          git config --global commit.gpgsign false
          
          cd experiments/sites
          
          # Clean up any existing git state from previous runs
          rm -rf .git
          
          git init
          git checkout --orphan pages
          
          # Set up Git LFS for large files (classification-cache.jsonl can exceed 100MB)
          git lfs install
          git lfs track "*.jsonl"
          git add .gitattributes
          
          git add -A
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit --no-gpg-sign -m "Deploy: ${{ github.sha }}"
          git push --force "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:pages
